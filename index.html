<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Calculator Pro - 2026 Strategy Edition</title>
    <style>
        :root {
            --sidebar-w: 220px; --brand: #2563eb; --bg-app: #f8fafc;
            --card-bg: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
            --border: #e2e8f0; --accent-bg: #f0f7ff; --success: #22c55e;
            --t1: #dbeafe; --t2: #fef3c7; --t3: #dcfce7; --t4: #f3e8ff;
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg-app: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9; --text-muted: #94a3b8; --border: #334155; --accent-bg: #1e293b; }
        }
        
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); display: flex; min-height: 100vh; width: 100vw; overflow-x: hidden; }
        aside { width: var(--sidebar-w); min-width: var(--sidebar-w); background: var(--card-bg); border-right: 1px solid var(--border); padding: 16px; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; box-sizing: border-box; }
        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; width: 100%; }
        header { height: 60px; background: var(--card-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; box-sizing: border-box; }
        main { padding: 20px; width: 100%; box-sizing: border-box; }

        #compare-banner { display: none; background: var(--accent-bg); border: 1px solid var(--brand); border-radius: 8px; padding: 12px; margin-bottom: 15px; position: relative; }
        .close-banner { position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 18px; color: var(--text-muted); font-weight: bold; }
        .compare-split { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; font-size: 12px; }
        .compare-box { background: var(--card-bg); border: 1px dashed var(--border); padding: 8px; border-radius: 6px; white-space: pre-wrap; max-height: 150px; overflow-y: auto; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .glass-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px; box-sizing: border-box; }
        textarea { width: 100%; min-height: 180px; padding: 15px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-app); color: var(--text-main); font-size: 14px; resize: vertical; box-sizing: border-box; margin-bottom: 10px; }
        
        .token-group { display: inline-flex; flex-direction: column; align-items: center; margin: 2px; }
        .token-idx { font-size: 8px; color: var(--text-muted); font-family: monospace; }
        .token-span { padding: 2px 4px; border-radius: 4px; font-family: monospace; font-size: 11px; white-space: pre; }
        
        .table-wrap { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 650px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border); }
        .num { font-family: monospace; text-align: right; }
        .btn { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; font-size: 13px; font-weight: 500; }
        
        .why-tag { font-size: 10px; color: var(--brand); background: var(--accent-bg); padding: 4px 8px; border-radius: 4px; display: block; margin-top: 6px; border-left: 3px solid var(--brand); }
    </style>
</head>
<body>

<aside>
    <h3 style="color:var(--brand); margin-bottom:20px;">Token Calculator</h3>
    <div id="history-list" style="flex:1; overflow-y:auto; font-size:11px;"></div>
    <button class="btn" style="background:var(--brand); color:white; border:none; margin-bottom:8px;" onclick="downloadData()">üì• Download JSON</button>
    <button class="btn" style="background:var(--success); color:white; border:none; margin-bottom:8px;" onclick="saveToHistory()">üíæ Save Text</button>
    <button class="btn" onclick="clearHistory()">üóë Clear</button>
</aside>

<div class="main-content">
    <header>
        <div style="display:flex; gap:10px;">
            <select id="ratio" onchange="calculate()" class="btn">
                <option value="0.2">üí¨ Short Reply</option>
                <option value="1" selected>üîÑ Balanced</option>
                <option value="3">‚úçÔ∏è Creative</option>
            </select>
            <input type="number" id="budgetLimit" class="btn" style="width:60px;" value="10" oninput="calculate()">
        </div>
        <div id="total-cost-head" style="font-size:22px; font-weight:800; color:var(--brand);">$0.00</div>
    </header>

    <main>
        <div id="compare-banner">
            <span class="close-banner" onclick="hideBanner()">√ó</span>
            <div style="display:flex; justify-content:space-between; align-items:center; padding-right: 30px;">
                <span id="compare-text" style="font-weight:700;"></span>
                <button class="btn" onclick="undoOptimize()">‚Ü© Undo</button>
            </div>
            <div class="compare-split">
                <div><small>ORIGINAL</small><div id="old-text-view" class="compare-box"></div></div>
                <div><small>OPTIMIZED</small><div id="new-text-view" class="compare-box"></div></div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="glass-card"><small>TOKENS IN</small><div id="in-count" style="font-size:20px; font-weight:700;">0</div></div>
            <div class="glass-card"><small>EST. OUTPUT</small><div id="out-count" style="font-size:20px; font-weight:700; color:#60a5fa;">0</div></div>
            <div class="glass-card"><small>PEAK COST</small><div id="peak-val" style="font-size:20px; font-weight:700; color:var(--brand);">$0.00</div></div>
        </div>

        <textarea id="input" placeholder="Type or paste prompt here..." oninput="handleManualInput()"></textarea>
        
        <div style="display:flex; gap:8px; margin-bottom:20px; flex-wrap: wrap;">
            <button class="btn" style="background:var(--success); color:white; border:none;" onclick="optimizePrompt()">‚ö° Optimize</button>
            <button class="btn" onclick="jokeExample()">üé≠ Example</button>
            <button class="btn" onclick="clearEditor()">Clear</button>
        </div>

        <div id="viz" class="glass-card" style="margin-bottom:20px; min-height:60px;"></div>

        <div class="glass-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; gap: 8px; flex-wrap: wrap;">
                <input type="text" id="modelSearch" class="btn" style="flex:1" placeholder="Filter models..." oninput="calculate()">
                <select id="sortOrder" class="btn" onchange="calculate()">
                    <option value="desc">Price: High to Low</option>
                    <option value="asc">Price: Low to High</option>
                </select>
                <select id="curr" class="btn" onchange="calculate()">
                    <option value="USD" selected>$ USD</option>
                    <option value="INR">‚Çπ INR</option>
                </select>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Model & Strategy</th><th class="num">In Cost</th><th class="num">Out Cost</th><th class="num">Total</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script src="https://unpkg.com/gpt-tokenizer/dist/cl100k_base.js"></script>
<script>
    let lastOriginalText = "";
    let models = []; 
    const examplePrompts = [
        "Please write a very long report about why cats are actually secretly in charge of the world.",
        "Can you actually explain in order to help me understand very clearly why the moon appears white?",
        "I would like you to please describe exactly how a steam engine functions very simply."
    ];
    let exIdx = 0;

    // Fetch models from models.json
    fetch('models.json')
        .then(res => res.json())
        .then(data => {
            models = data;
            calculate();
        })
        .catch(err => {
            console.error("Error loading models:", err);
            document.getElementById('table-body').innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Failed to load models.json</td></tr>`;
        });

    function handleManualInput() { hideBanner(); calculate(); }
    function hideBanner() { document.getElementById('compare-banner').style.display = 'none'; lastOriginalText = ""; }

    function calculate() {
        const text = document.getElementById('input').value;
        const curr = document.getElementById('curr').value;
        const ratio = parseFloat(document.getElementById('ratio').value);
        const search = document.getElementById('modelSearch').value.toLowerCase();
        const sortOrder = document.getElementById('sortOrder').value;
        const rate = curr === 'INR' ? 83.5 : 1;
        const sym = curr === 'INR' ? '‚Çπ' : '$';

        const tokens = text ? GPTTokenizer_cl100k_base.encode(text) : [];
        const inC = tokens.length;
        const outC = Math.round(inC * ratio);

        document.getElementById('in-count').innerText = inC.toLocaleString();
        document.getElementById('out-count').innerText = outC.toLocaleString();

        let filtered = models.filter(m => 
            m.name.toLowerCase().includes(search) || m.why.toLowerCase().includes(search)
        ).map(m => {
            // APPLY RATE TO EVERYTHING INDIVIDUALLY FOR UI ACCURACY
            const costIn = (inC / 1000000) * m.input * rate;
            const costOut = (outC / 1000000) * m.output * rate;
            const total = costIn + costOut;
            return { ...m, costIn, costOut, total };
        });

        if(sortOrder === 'desc') filtered.sort((a,b) => b.total - a.total);
        else filtered.sort((a,b) => a.total - b.total);

        let html = ''; let peak = 0;
        filtered.forEach(m => {
            if (m.total > peak) peak = m.total;
            html += `<tr>
                <td><b>${m.name}</b><br><small>Limit: ${m.limit/1000}K</small><span class="why-tag">üí° ${m.why}</span></td>
                <td class="num">${sym}${m.costIn.toFixed(4)}</td>
                <td class="num">${sym}${m.costOut.toFixed(4)}</td>
                <td class="num" style="color:var(--brand); font-weight:700;">${sym}${m.total.toFixed(2)}</td>
            </tr>`;
        });

        document.getElementById('table-body').innerHTML = html;
        document.getElementById('total-cost-head').innerText = sym + peak.toFixed(2);
        document.getElementById('peak-val').innerText = sym + peak.toFixed(2);
        renderViz(tokens);
    }

    function downloadData() {
        const text = document.getElementById('input').value;
        if(!text) return alert("Please enter some text first.");
        
        const table = document.getElementById('table-body');
        const rows = Array.from(table.querySelectorAll('tr'));
        const modelData = rows.map(row => {
            const cols = row.querySelectorAll('td');
            return {
                model: cols[0].querySelector('b').innerText,
                strategy: cols[0].querySelector('.why-tag').innerText.replace('üí° ', ''),
                costIn: cols[1].innerText,
                costOut: cols[2].innerText,
                totalCost: cols[3].innerText
            };
        });

        const exportObj = {
            metadata: { 
                timestamp: new Date().toISOString(), 
                input_tokens: document.getElementById('in-count').innerText, 
                estimated_output: document.getElementById('out-count').innerText, 
                currency: document.getElementById('curr').value 
            },
            prompt_content: text,
            analysis: modelData
        };

        const now = new Date();
        const fileName = `token-analysis-${now.toISOString().replace(/[:T]/g, '-').slice(0, 19)}.json`;
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", fileName);
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    function renderViz(tokens) {
        const viz = document.getElementById('viz');
        viz.innerHTML = tokens.length ? '' : '<small style="color:var(--text-muted)">Token visualization...</small>';
        tokens.slice(0, 50).forEach((t, i) => {
            const g = document.createElement('div'); g.className = 'token-group';
            g.innerHTML = `<span class="token-idx">${i+1}</span><span class="token-span" style="background:var(--t${(i%4)+1})">${GPTTokenizer_cl100k_base.decode([t])}</span>`;
            viz.appendChild(g);
        });
    }

    function optimizePrompt() {
        const input = document.getElementById('input');
        if(!input.value) return;
        const currentText = input.value;
        const optimized = currentText.replace(/\b(Please|Actually|Very|I would like you to|Can you|I want you to|In order to)\b/gi, '').replace(/\s+/g, ' ').trim();
        if (optimized === currentText) return;
        lastOriginalText = currentText;
        input.value = optimized;
        const saved = GPTTokenizer_cl100k_base.encode(lastOriginalText).length - GPTTokenizer_cl100k_base.encode(optimized).length;
        document.getElementById('compare-banner').style.display = 'block';
        document.getElementById('compare-text').innerText = `‚ú® Saved ${saved} Tokens!`;
        document.getElementById('old-text-view').innerText = lastOriginalText;
        document.getElementById('new-text-view').innerText = optimized;
        calculate();
    }

    function jokeExample() { hideBanner(); document.getElementById('input').value = examplePrompts[exIdx]; exIdx = (exIdx + 1) % examplePrompts.length; calculate(); }
    function clearEditor() { document.getElementById('input').value = ''; hideBanner(); calculate(); }
    function undoOptimize() { if(lastOriginalText) { document.getElementById('input').value = lastOriginalText; hideBanner(); calculate(); } }
    
    function saveToHistory() {
        const txt = document.getElementById('input').value; if(!txt) return;
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        h.unshift({t: txt, d: new Date().toLocaleTimeString()});
        localStorage.setItem('h', JSON.stringify(h.slice(0,10)));
        renderHistory();
    }
    
    function renderHistory() {
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        document.getElementById('history-list').innerHTML = h.map(i => `<div style="padding:8px; border-bottom:1px solid var(--border); cursor:pointer;" onclick="document.getElementById('input').value='${i.t.replace(/'/g, "\\'")}';calculate();"><b>${i.d}</b>: ${i.t.substring(0,20)}...</div>`).join('') || 'No history';
    }
    
    function clearHistory() { localStorage.removeItem('h'); renderHistory(); }
    
    renderHistory();
</script>
</body>
</html>
