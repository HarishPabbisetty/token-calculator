<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Calculator</title>
    <style>
        :root {
            --sidebar-w: 220px; 
            --brand: #2563eb; --bg-app: #f8fafc;
            --card-bg: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
            --border: #e2e8f0; --accent-bg: #f0f7ff;
            --danger: #ef4444; --success: #22c55e;
            --t1: #dbeafe; --t2: #fef3c7; --t3: #dcfce7; --t4: #f3e8ff;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-app: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9;
                --text-muted: #94a3b8; --border: #334155; --accent-bg: #1e293b;
            }
        }
        
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg-app); color: var(--text-main); }
        .app-container { display: flex; min-height: 100vh; width: 100%; }

        aside {
            width: var(--sidebar-w); min-width: var(--sidebar-w); background: var(--card-bg); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 16px; box-sizing: border-box; height: 100vh; position: sticky; top: 0;
        }
        @media (max-width: 1023px) {
            aside { position: fixed; left: 0; z-index: 2000; transform: translateX(-100%); transition: 0.3s; }
            aside.open { transform: translateX(0); }
        }

        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        header { height: 60px; background: var(--card-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        main { padding: 20px; box-sizing: border-box; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .glass-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }

        .workspace-layout { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1200px) { .workspace-layout { grid-template-columns: 4fr 6fr; } }

        textarea { width: 100%; min-height: 200px; padding: 15px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-app); color: var(--text-main); font-size: 15px; resize: vertical; box-sizing: border-box; }

        .controls-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .search-input { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-app); color: var(--text-main); outline: none; }

        .table-container { overflow-x: auto; scrollbar-width: none; }
        .table-container::-webkit-scrollbar { display: none; }

        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { text-align: left; padding: 12px; color: var(--text-muted); border-bottom: 2px solid var(--border); }
        td { padding: 12px; border-bottom: 1px solid var(--border); }
        
        /* Context Bar */
        .ctx-bar-bg { width: 100%; height: 4px; background: var(--border); border-radius: 2px; margin-top: 4px; overflow: hidden; }
        .ctx-bar-fill { height: 100%; transition: width 0.3s ease; }

        .num { font-family: monospace; text-align: right; font-weight: 500; }
        .model-name { color: var(--brand); cursor: pointer; font-weight: 600; text-decoration: underline; }
        .btn { padding: 8px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; font-size: 13px; }
        .copy-trigger { cursor: pointer; margin-left: 8px; color: var(--text-muted); }
        .token-span { padding: 2px 4px; border-radius: 4px; margin: 1px; display: inline-block; font-family: monospace; font-size: 11px; }
    </style>
</head>
<body>

<div id="info-modal" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; z-index:3000;" onclick="this.style.display='none'">
    <div class="glass-card" style="width:350px;" onclick="event.stopPropagation()">
        <h3 id="m-title" style="margin-top:0;">Model Info</h3>
        <p id="m-desc" style="font-size:14px; color:var(--text-muted); line-height:1.5;"></p>
        <button class="btn" style="width:100%; background:var(--brand); color:white; border:none;" onclick="document.getElementById('info-modal').style.display='none'">Close</button>
    </div>
</div>

<div class="app-container">
    <aside id="sidebar">
        <h3 style="margin:0 0 15px 0; color:var(--brand);">Token Calculator</h3>
        <div id="history-list" style="flex:1; overflow-y:auto; font-size:11px;"></div>
        <button class="btn" style="background:var(--brand); color:white; border:none; margin-bottom:8px;" onclick="saveToHistory()">üíæ Save</button>
        <button class="btn" style="color:var(--danger); border-color:#fee2e2" onclick="clearHistory()">üóë Clear History</button>
    </aside>

    <div class="main-content">
        <header>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="btn" onclick="document.getElementById('sidebar').classList.toggle('open')">‚ò∞</button>
                <select id="ratio" onchange="calculate()" class="btn">
                    <option value="1">1:1 Chat</option>
                    <option value="0.2">1:0.2 Summary</option>
                    <option value="3">1:3 Creative</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="jokeExample()">üé≠ Humor</button>
                <button class="btn" onclick="clearEditor()" style="color:var(--danger)">Clear</button>
                <select id="curr" onchange="calculate()" class="btn">
                    <option value="USD">$ USD</option>
                    <option value="EUR">‚Ç¨ EUR</option>
                    <option value="INR">‚Çπ INR</option>
                </select>
            </div>
        </header>

        <main>
            <div class="stats-grid">
                <div class="glass-card"><small style="font-weight:700;">TOKENS IN</small><div id="in-count" style="font-size:24px; font-weight:800; margin-top:5px;">0</div></div>
                <div class="glass-card" style="border-left: 4px solid var(--brand);">
                    <div style="display:flex; justify-content:space-between; align-items:start;">
                        <small style="font-weight:700;">TOTAL COST</small>
                        <span id="copyBtn" class="copy-trigger" onclick="copyCost()" title="Copy Cost">üìã</span>
                    </div>
                    <div id="total-cost" style="font-size:24px; font-weight:800; color:var(--brand); margin-top:5px;">$0.00</div>
                </div>
            </div>

            <div class="workspace-layout">
                <div>
                    <textarea id="input" placeholder="Paste text here..." oninput="calculate()"></textarea>
                    <div id="viz" class="glass-card" style="margin-top:15px; min-height:80px;"></div>
                </div>
                <div class="glass-card table-container">
                    <div class="controls-row">
                        <input type="text" id="modelSearch" class="search-input" placeholder="üîç Search models..." oninput="calculate()">
                        <select id="sortOrder" class="btn" onchange="calculate()">
                            <option value="desc">Price: Large to Small</option>
                            <option value="asc">Price: Small to Large</option>
                            <option value="name">Name: A-Z</option>
                        </select>
                    </div>
                    <table>
                        <thead>
                            <tr><th>Model / Context Window</th><th class="num">In</th><th class="num">Out</th><th class="num">Total</th></tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://unpkg.com/gpt-tokenizer/dist/cl100k_base.js"></script>
<script>
    let models = [];
    let exchangeRates = { USD: 1, EUR: 0.92, INR: 83.5 }; 
    const symbols = { USD: '$', EUR: '‚Ç¨', INR: '‚Çπ' };

    async function init() {
        try {
            const modelRes = await fetch('models.json');
            models = await modelRes.json();
            const rateRes = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
            const rateData = await rateRes.json();
            exchangeRates = rateData.rates;
        } catch(e) { console.warn("Using fallback exchange rates."); }
        renderHistory();
        calculate();
    }

    function formatPrice(usd) {
        if (isNaN(usd)) return "---";
        const cur = document.getElementById('curr').value;
        const rate = exchangeRates[cur] || 1;
        const symbol = symbols[cur];
        const val = usd * rate;
        return symbol + (val === 0 ? "0.00" : (val < 0.01 ? val.toFixed(4) : val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})));
    }

    function calculate() {
        const text = document.getElementById('input').value;
        const searchTerm = document.getElementById('modelSearch').value.toLowerCase();
        const sortOrder = document.getElementById('sortOrder').value;
        const tokens = text ? GPTTokenizer_cl100k_base.encode(text) : [];
        const count = tokens.length;
        const ratio = parseFloat(document.getElementById('ratio').value);
        
        document.getElementById('in-count').innerText = count.toLocaleString();
        
        // 1. Calculate costs for all models
        let results = models.map(m => {
            const costIn = (count / 1000000) * (m.input || 0);
            const costOut = ((count * ratio) / 1000000) * (m.output || 0);
            return { ...m, costIn, costOut, total: costIn + costOut };
        });

        // 2. Sort results
        if (sortOrder === 'desc') results.sort((a, b) => b.total - a.total);
        else if (sortOrder === 'asc') results.sort((a, b) => a.total - b.total);
        else results.sort((a, b) => a.name.localeCompare(b.name));

        let html = ''; let totalSum = 0; let visibleCount = 0;

        results.forEach(m => {
            if (m.name.toLowerCase().includes(searchTerm)) {
                totalSum += m.total; visibleCount++;
                const limit = m.limit || 128000; // Fallback to avoid NaN
                const usagePct = Math.min((count / limit) * 100, 100);
                const isOver = count > limit;
                
                html += `<tr>
                    <td>
                        <div class="model-name" onclick="showInfo('${m.name}')">${m.name} ${isOver ? '‚ö†Ô∏è' : ''}</div>
                        <div style="font-size:10px; color:var(--text-muted); margin-top:2px;">Limit: ${(limit/1000).toFixed(0)}k</div>
                        <div class="ctx-bar-bg">
                            <div class="ctx-bar-fill" style="width:${usagePct}%; background:${isOver ? 'var(--danger)' : 'var(--brand)'}"></div>
                        </div>
                    </td>
                    <td class="num">${formatPrice(m.costIn)}</td>
                    <td class="num">${formatPrice(m.costOut)}</td>
                    <td class="num" style="font-weight:bold; color:var(--brand);">${formatPrice(m.total)}</td>
                </tr>`;
            }
        });
        
        document.getElementById('table-body').innerHTML = html || '<tr><td colspan="4" style="text-align:center;">No results</td></tr>';
        document.getElementById('total-cost').innerText = formatPrice(visibleCount ? (totalSum / visibleCount) : 0);
        
        // Visualization
        const viz = document.getElementById('viz');
        viz.innerHTML = '<small style="display:block;margin-bottom:8px;color:var(--text-muted)">Token Visualization:</small>';
        tokens.slice(0, 60).forEach((t, i) => {
            const s = document.createElement('span'); s.className = 'token-span';
            s.style.background = `var(--t${(i % 4) + 1})`;
            s.textContent = GPTTokenizer_cl100k_base.decode([t]);
            viz.appendChild(s);
        });
    }

    function copyCost() {
        const costText = document.getElementById('total-cost').innerText;
        navigator.clipboard.writeText(costText).then(() => {
            const btn = document.getElementById('copyBtn');
            btn.innerText = '‚úÖ';
            setTimeout(() => { btn.innerText = 'üìã'; }, 1500);
        });
    }

    function showInfo(name) {
        const m = models.find(x => x.name === name);
        if(!m) return;
        document.getElementById('m-title').innerText = m.name;
        document.getElementById('m-desc').innerText = `Input: $${m.input}/M\nOutput: $${m.output}/M\nContext: ${(m.limit || 128000).toLocaleString()} tokens`;
        document.getElementById('info-modal').style.display = 'flex';
    }

    function saveToHistory() {
        const text = document.getElementById('input').value;
        if(!text) return;
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        h.unshift({t: text, d: new Date().toLocaleTimeString()});
        localStorage.setItem('h', JSON.stringify(h.slice(0,10)));
        renderHistory();
    }

    function renderHistory() {
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        document.getElementById('history-list').innerHTML = h.length ? h.map(i => `
            <div style="padding:8px; border-bottom:1px solid var(--border); cursor:pointer;" onclick="document.getElementById('input').value='${i.t.replace(/'/g, "\\'")}';calculate();">
                <b>${i.d}</b>: ${i.t.substring(0,30)}...
            </div>`).join('') : '<p style="padding:10px; color:var(--text-muted)">Empty</p>';
    }

    function clearEditor() { document.getElementById('input').value = ''; calculate(); }
    function clearHistory() { if(confirm("Wipe history?")) { localStorage.removeItem('h'); renderHistory(); } }
    function jokeExample() { 
        const jokes = ["Why was the computer cold? It left its Windows open!", "An AI walks into a bar... 'What can I get you?' 'More data.'"];
        document.getElementById('input').value = jokes[Math.floor(Math.random()*jokes.length)];
        calculate();
    }

    init();
</script>
</body>
</html>
