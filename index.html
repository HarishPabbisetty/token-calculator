<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Calculator Pro - 2026 Strategy</title>
    <style>
        :root {
            --sidebar-w: 260px; --brand: #2563eb; --bg-app: #f8fafc;
            --card-bg: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
            --border: #e2e8f0; --accent-bg: #f0f7ff; --success: #22c55e; --danger: #ef4444;
            --t1: #dbeafe; --t2: #fef3c7; --t3: #dcfce7; --t4: #f3e8ff;
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg-app: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9; --text-muted: #94a3b8; --border: #334155; --accent-bg: #1e293b; }
        }
        
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); display: flex; min-height: 100vh; width: 100vw; overflow-x: hidden; }

        /* Sidebar & Menu Logic */
        aside { 
            width: var(--sidebar-w); background: var(--card-bg); border-right: 1px solid var(--border); 
            padding: 20px; display: flex; flex-direction: column; height: 100vh; 
            position: fixed; left: 0; top: 0; z-index: 2000;
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
        }
        aside.open { transform: translateX(0); }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 1500; backdrop-filter: blur(2px); }

        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; width: 100%; }
        header { height: 70px; background: var(--card-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        main { padding: 20px; width: 100%; box-sizing: border-box; max-width: 1200px; margin: 0 auto; }

        .menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-main); display: flex; align-items: center; }

        #compare-banner { display: none; background: var(--accent-bg); border: 1px solid var(--brand); border-radius: 12px; padding: 16px; margin-bottom: 20px; position: relative; }
        .compare-split { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; font-size: 12px; }
        .compare-box { background: var(--card-bg); border: 1px dashed var(--border); padding: 10px; border-radius: 8px; white-space: pre-wrap; max-height: 120px; overflow-y: auto; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .glass-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 18px; box-sizing: border-box; }
        
        textarea { width: 100%; min-height: 180px; padding: 18px; border-radius: 12px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 15px; resize: vertical; box-sizing: border-box; margin-bottom: 10px; outline: none; }
        
        .token-group { display: inline-flex; flex-direction: column; align-items: center; margin: 3px; }
        .token-idx { font-size: 9px; color: var(--text-muted); font-family: monospace; }
        .token-span { padding: 3px 6px; border-radius: 5px; font-family: monospace; font-size: 12px; }
        
        .table-wrap { overflow-x: auto; margin-top: 10px; border: 1px solid var(--border); border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; }
        th, td { text-align: left; padding: 14px; border-bottom: 1px solid var(--border); }
        .num { font-family: monospace; text-align: right; }
        
        .btn { padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-main); display: inline-flex; align-items: center; gap: 8px; }
        .why-tag { font-size: 10px; color: var(--brand); background: var(--accent-bg); padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 6px; border-left: 3px solid var(--brand); font-weight: 700; }

        @media (min-width: 1024px) {
            aside { transform: translateX(0); position: sticky; top: 0; }
            .menu-btn { display: none; }
            #overlay { display: none !important; }
        }
    </style>
</head>
<body>

<div id="overlay" onclick="toggleMenu()"></div>

<aside id="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="color:var(--brand); margin:0;">Dashboard</h3>
        <button class="menu-btn" onclick="toggleMenu()">‚úï</button>
    </div>
    
    <div id="history-list" style="flex:1; overflow-y:auto; margin-bottom: 20px;"></div>

    <div style="display:flex; flex-direction:column; gap:8px;">
        <button class="btn" style="background:var(--brand); color:white; border:none;" onclick="downloadData()">üì• Download JSON</button>
        <button class="btn" style="background:var(--success); color:white; border:none;" onclick="saveToHistory()">üíæ Chache it </button>
        <button class="btn" onclick="clearHistory()" style="color:var(--danger)">üóë Clear History</button>
    </div>
</aside>

<div class="main-content">
    <header>
        <div style="display:flex; align-items:center; gap:12px;">
            <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
            <select id="ratio" onchange="calculate()" class="btn">
                <option value="0.2">üí¨ Short Reply</option>
                <option value="1" selected>üîÑ Balanced</option>
                <option value="3">‚úçÔ∏è Creative</option>
            </select>
        </div>
        <div id="total-cost-head" style="font-size:24px; font-weight:800; color:var(--brand);">$0.00</div>
    </header>

    <main>
        <div id="compare-banner">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <span id="compare-text" style="font-weight:700; color:var(--brand);"></span>
                <button class="btn" onclick="undoOptimize()" style="padding:4px 8px; font-size:11px;">‚Ü© Undo</button>
            </div>
            <div class="compare-split">
                <div id="old-text-view" class="compare-box"></div>
                <div id="new-text-view" class="compare-box"></div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="glass-card"><small>TOKENS IN</small><div id="in-count" style="font-size:22px; font-weight:800;">0</div></div>
            <div class="glass-card"><small style="color:#60a5fa">EST. OUTPUT</small><div id="out-count" style="font-size:22px; font-weight:800; color:#60a5fa">0</div></div>
            <div class="glass-card"><small>PEAK COST</small><div id="peak-val" style="font-size:22px; font-weight:800; color:var(--brand);">$0.00</div></div>
        </div>

        <textarea id="input" placeholder="Type or paste prompt here..." oninput="handleManualInput()"></textarea>
        
        <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap;">
            <button class="btn" style="background:var(--success); color:white; border:none;" onclick="optimizePrompt()">‚ö° Optimize</button>
            <button class="btn" onclick="jokeExample()">üé≠ Example</button>
            <button class="btn" onclick="clearEditor()">Clear</button>
            <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
                <small style="font-size:11px; font-weight:700;">BUDGET:</small>
                <input type="number" id="budgetLimit" class="btn" style="width:70px;" value="10" oninput="calculate()">
            </div>
        </div>

        <div id="viz" class="glass-card" style="margin-bottom:20px; min-height:60px; overflow-x: auto; display: flex; flex-wrap: wrap;"></div>

        <div class="glass-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="modelSearch" class="btn" style="flex:2; min-width:180px;" placeholder="üîç Filter models..." oninput="calculate()">
                <select id="sortOrder" class="btn" onchange="calculate()">
                    <option value="asc">Price: Low to High</option>
                    <option value="desc">Price: High to Low</option>
                </select>
                <select id="curr" class="btn" onchange="calculate()">
                    <option value="USD" selected>$ USD</option>
                    <option value="INR">‚Çπ INR</option>
                </select>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Model & Strategy</th><th class="num">In Cost</th><th class="num">Out Cost</th><th class="num">Total</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script src="https://unpkg.com/gpt-tokenizer/dist/cl100k_base.js"></script>
<script>
    let lastOriginalText = "";
    let models = []; 

    function toggleMenu() {
        const side = document.getElementById('sidebar');
        const over = document.getElementById('overlay');
        const isOpen = side.classList.toggle('open');
        over.style.display = isOpen ? 'block' : 'none';
    }

    fetch('models.json')
        .then(res => res.json())
        .then(data => { models = data; calculate(); })
        .catch(err => {
            console.error("models.json error:", err);
            document.getElementById('table-body').innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Check models.json path</td></tr>`;
        });

    function handleManualInput() { hideBanner(); calculate(); }
    function hideBanner() { document.getElementById('compare-banner').style.display = 'none
