<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Calculator Pro - Responsive</title>
    <style>
        :root {
            --sidebar-w: 220px; --brand: #2563eb; --bg-app: #f8fafc;
            --card-bg: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
            --border: #e2e8f0; --accent-bg: #f0f7ff; --danger: #ef4444; 
            --success: #22c55e; --t1: #dbeafe; --t2: #fef3c7; --t3: #dcfce7; --t4: #f3e8ff;
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg-app: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9; --text-muted: #94a3b8; --border: #334155; --accent-bg: #1e293b; }
        }
        
        /* Layout Fix: Responsive Width */
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); display: flex; min-height: 100vh; width: 100vw; overflow-x: hidden; }
        
        aside { width: var(--sidebar-w); min-width: var(--sidebar-w); background: var(--card-bg); border-right: 1px solid var(--border); padding: 16px; display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; box-sizing: border-box; }
        
        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; width: 100%; }
        
        header { height: 60px; background: var(--card-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; box-sizing: border-box; }
        
        main { padding: 20px; width: 100%; box-sizing: border-box; max-width: 1600px; margin: 0 auto; }

        /* Component Styles */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .glass-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px; box-sizing: border-box; }
        
        textarea { width: 100%; min-height: 200px; padding: 15px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-app); color: var(--text-main); font-size: 14px; resize: vertical; box-sizing: border-box; margin-bottom: 10px; }
        
        #compare-banner { display: none; background: var(--accent-bg); border: 1px solid var(--brand); border-radius: 8px; padding: 12px; margin-bottom: 15px; }
        .compare-split { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; font-size: 12px; }
        .compare-box { background: var(--card-bg); border: 1px dashed var(--border); padding: 8px; border-radius: 6px; white-space: pre-wrap; max-height: 150px; overflow-y: auto; }

        .token-group { display: inline-flex; flex-direction: column; align-items: center; margin: 2px; }
        .token-idx { font-size: 8px; color: var(--text-muted); font-family: monospace; }
        .token-span { padding: 2px 4px; border-radius: 4px; font-family: monospace; font-size: 11px; white-space: pre; }
        
        .ctx-bar-bg { width: 100%; height: 6px; background: var(--border); border-radius: 10px; margin-top: 6px; overflow: hidden; display: flex; }
        .ctx-bar-in { height: 100%; background: var(--brand); transition: 0.3s; }
        .ctx-bar-out { height: 100%; background: #93c5fd; opacity: 0.5; transition: 0.3s; }

        .table-wrap { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border); }
        .num { font-family: monospace; text-align: right; }
        
        .btn { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; font-size: 13px; font-weight: 500; }
        .btn-success { background: var(--success); color: white; border: none; }
        
        #analysis-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 999; align-items: center; justify-content: center; }

        /* Responsive Breakpoints */
        @media (max-width: 768px) {
            aside { display: none; }
            .compare-split { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="analysis-modal">
    <div class="glass-card" style="width: 400px; max-width: 90vw;">
        <h3>üîç Word Analysis</h3>
        <div id="analysis-results"></div>
        <button class="btn" style="width:100%; margin-top:15px;" onclick="closeAnalysis()">Close</button>
    </div>
</div>

<aside>
    <h3 style="color:var(--brand); margin-bottom:20px;">Token Calc</h3>
    <div id="history-list" style="flex:1; overflow-y:auto; font-size:11px;"></div>
    <button class="btn btn-success" style="margin-bottom:8px;" onclick="saveToHistory()">üíæ Save Text</button>
    <button class="btn" onclick="clearHistory()">üóë Clear</button>
</aside>

<div class="main-content">
    <header>
        <div style="display:flex; gap:10px;">
            <select id="ratio" onchange="calculate()" class="btn">
                <option value="0.2">üí¨ Short Reply</option>
                <option value="1" selected>üîÑ Balanced</option>
                <option value="3">‚úçÔ∏è Creative</option>
            </select>
            <input type="number" id="budgetLimit" class="btn" style="width:60px;" value="10" oninput="calculate()">
        </div>
        <div id="total-cost-head" style="font-size:22px; font-weight:800; color:var(--brand);">$0.00</div>
    </header>

    <main>
        <div id="compare-banner">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <span id="compare-text" style="font-weight:700;"></span>
                <button class="btn" onclick="undoOptimize()">‚Ü© Undo</button>
            </div>
            <div class="compare-split">
                <div><small>ORIGINAL</small><div id="old-text-view" class="compare-box"></div></div>
                <div><small>OPTIMIZED</small><div id="new-text-view" class="compare-box"></div></div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="glass-card"><small>TOKENS IN</small><div id="in-count" style="font-size:20px; font-weight:700;">0</div></div>
            <div class="glass-card"><small>EST. OUTPUT</small><div id="out-count" style="font-size:20px; font-weight:700; color:#60a5fa;">0</div></div>
            <div class="glass-card"><small>PEAK COST</small><div id="peak-val" style="font-size:20px; font-weight:700; color:var(--brand);">$0.00</div></div>
        </div>

        <textarea id="input" placeholder="Type here..." oninput="handleManualInput()"></textarea>
        
        <div style="display:flex; gap:8px; margin-bottom:20px; flex-wrap: wrap;">
            <button class="btn btn-success" onclick="optimizePrompt()">‚ö° Optimize</button>
            <button class="btn" onclick="showAnalysis()">üîç Analysis</button>
            <button class="btn" onclick="jokeExample()">üé≠ Example</button>
            <button class="btn" onclick="clearEditor()">Clear</button>
        </div>

        <div id="viz" class="glass-card" style="margin-bottom:20px; min-height:60px;"></div>

        <div class="glass-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; gap: 8px; flex-wrap: wrap;">
                <input type="text" id="modelSearch" class="btn" style="flex:1" placeholder="Filter models..." oninput="calculate()">
                <select id="sortOrder" class="btn" onchange="calculate()">
                    <option value="desc">Price: High to Low</option>
                    <option value="asc">Price: Low to High</option>
                </select>
                <select id="curr" class="btn" onchange="calculate()">
                    <option value="USD" selected>$ USD</option>
                    <option value="INR">‚Çπ INR</option>
                </select>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Model</th><th class="num">In</th><th class="num">Out</th><th class="num">Total</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script src="https://unpkg.com/gpt-tokenizer/dist/cl100k_base.js"></script>
<script>
    let models = [];
    let lastOriginalText = "";
    const examplePrompts = [
        "Please write a very long report about why cats are actually secretly in charge of the world.",
        "Can you actually explain in order to help me understand very clearly why the moon appears white?",
        "I would like you to please describe exactly how a steam engine functions very simply."
    ];
    let exIdx = 0;

    async function init() {
        try {
            const res = await fetch('models.json?v=' + Date.now());
            models = res.ok ? await res.json() : getBackupModels();
        } catch(e) { models = getBackupModels(); }
        renderHistory();
        calculate();
    }

    function getBackupModels() {
        return [
            {name:"GPT-5.2 Pro", input:6.8, output:55, limit:128000},
            {name:"Claude 4.5 Opus", input:2.3, output:8, limit:200000},
            {name:"Gemini 3 Pro", input:0.7, output:4.5, limit:2000000}
        ];
    }

    function handleManualInput() {
        // Reset optimized view when user types something new
        document.getElementById('compare-banner').style.display = 'none';
        lastOriginalText = "";
        calculate();
    }

    function calculate() {
        const text = document.getElementById('input').value;
        const curr = document.getElementById('curr').value;
        const ratio = parseFloat(document.getElementById('ratio').value);
        const search = document.getElementById('modelSearch').value.toLowerCase();
        const sortOrder = document.getElementById('sortOrder').value;
        const sym = curr === 'INR' ? '‚Çπ' : '$';
        const rate = curr === 'INR' ? 83.5 : 1;

        const tokens = text ? GPTTokenizer_cl100k_base.encode(text) : [];
        const inC = tokens.length;
        const outC = Math.round(inC * ratio);

        document.getElementById('in-count').innerText = inC.toLocaleString();
        document.getElementById('out-count').innerText = outC.toLocaleString();

        let data = models.filter(m => m.name.toLowerCase().includes(search)).map(m => {
            const cIn = (inC / 1000000) * m.input;
            const cOut = (outC / 1000000) * m.output;
            const total = (cIn + cOut) * rate;
            return { ...m, cIn, cOut, total };
        });

        if(sortOrder === 'desc') data.sort((a,b) => b.total - a.total);
        else data.sort((a,b) => a.total - b.total);

        let html = ''; let peak = 0;
        data.forEach(m => {
            if (m.total > peak) peak = m.total;
            const inPct = Math.min((inC / m.limit) * 100, 100);
            const outPct = Math.min((outC / m.limit) * 100, 100 - inPct);

            html += `<tr><td><b>${m.name}</b><br><small>Limit: ${m.limit/1000}K</small>
                <div class="ctx-bar-bg"><div class="ctx-bar-in" style="width:${inPct}%"></div><div class="ctx-bar-out" style="width:${outPct}%"></div></div></td>
                <td class="num">${sym}${m.cIn.toFixed(4)}</td><td class="num">${sym}${m.cOut.toFixed(4)}</td>
                <td class="num" style="color:var(--brand); font-weight:700;">${sym}${m.total.toFixed(2)}</td></tr>`;
        });

        document.getElementById('table-body').innerHTML = html;
        document.getElementById('total-cost-head').innerText = sym + peak.toFixed(2);
        document.getElementById('peak-val').innerText = sym + peak.toFixed(2);
        renderViz(tokens);
    }

    function renderViz(tokens) {
        const viz = document.getElementById('viz');
        viz.innerHTML = tokens.length ? '' : '<small style="color:var(--text-muted)">Token visualization...</small>';
        tokens.slice(0, 50).forEach((t, i) => {
            const g = document.createElement('div'); g.className = 'token-group';
            g.innerHTML = `<span class="token-idx">${i+1}</span><span class="token-span" style="background:var(--t${(i%4)+1})">${GPTTokenizer_cl100k_base.decode([t])}</span>`;
            viz.appendChild(g);
        });
    }

    function optimizePrompt() {
        const input = document.getElementById('input');
        if(!input.value) return;
        const currentText = input.value;
        // Logic to remove fluff words
        const optimized = currentText.replace(/\b(Please|Actually|Very|I would like you to|Can you|I want you to|In order to)\b/gi, '').replace(/\s+/g, ' ').trim();
        
        if (optimized === currentText) return;

        lastOriginalText = currentText;
        input.value = optimized;
        const saved = GPTTokenizer_cl100k_base.encode(lastOriginalText).length - GPTTokenizer_cl100k_base.encode(optimized).length;
        
        document.getElementById('compare-banner').style.display = 'block';
        document.getElementById('compare-text').innerText = `‚ú® Saved ${saved} Tokens!`;
        document.getElementById('old-text-view').innerText = lastOriginalText;
        document.getElementById('new-text-view').innerText = optimized;
        calculate();
    }

    function jokeExample() {
        // RESET FIX: Hide the banner and reset cached text when clicking Example
        document.getElementById('compare-banner').style.display = 'none';
        lastOriginalText = ""; 
        
        document.getElementById('input').value = examplePrompts[exIdx];
        exIdx = (exIdx + 1) % examplePrompts.length;
        
        // Optimize the fresh example
        optimizePrompt();
    }

    function showAnalysis() {
        const words = document.getElementById('input').value.toLowerCase().match(/\b\w+\b/g) || [];
        const counts = {};
        words.forEach(w => counts[w] = (counts[w] || 0) + GPTTokenizer_cl100k_base.encode(w).length);
        const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]).slice(0, 5);
        document.getElementById('analysis-results').innerHTML = sorted.map(([w, c]) => `<div style="display:flex; justify-content:space-between; padding:5px 0; border-bottom:1px solid var(--border);"><span>"${w}"</span><b>${c} tokens</b></div>`).join('') || 'No words.';
        document.getElementById('analysis-modal').style.display = 'flex';
    }

    function closeAnalysis() { document.getElementById('analysis-modal').style.display = 'none'; }
    function clearEditor() { document.getElementById('input').value = ''; document.getElementById('compare-banner').style.display = 'none'; lastOriginalText = ''; calculate(); }
    function undoOptimize() { if(lastOriginalText) { document.getElementById('input').value = lastOriginalText; document.getElementById('compare-banner').style.display = 'none'; lastOriginalText = ''; calculate(); } }
    
    function saveToHistory() {
        const txt = document.getElementById('input').value; if(!txt) return;
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        h.unshift({t: txt, d: new Date().toLocaleTimeString()});
        localStorage.setItem('h', JSON.stringify(h.slice(0,10)));
        renderHistory();
    }
    
    function renderHistory() {
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        document.getElementById('history-list').innerHTML = h.map(i => `<div style="padding:8px; border-bottom:1px solid var(--border); cursor:pointer;" onclick="document.getElementById('input').value='${i.t.replace(/'/g, "\\'")}';handleManualInput();"><b>${i.d}</b>: ${i.t.substring(0,20)}...</div>`).join('') || 'No history';
    }
    
    function clearHistory() { localStorage.removeItem('h'); renderHistory(); }
    init();
</script>
</body>
</html>
