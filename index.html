<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPT Token Cost Calculator</title>
    <style>
        :root {
            --sidebar-w: 220px; 
            --brand: #2563eb; --bg-app: #f8fafc;
            --card-bg: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
            --border: #e2e8f0; --accent-bg: #f0f7ff;
            --t1: #dbeafe; --t2: #fef3c7; --t3: #dcfce7; --t4: #f3e8ff;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-app: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9;
                --text-muted: #94a3b8; --border: #334155; --accent-bg: #1e293b;
            }
        }
        
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg-app); color: var(--text-main); -webkit-font-smoothing: antialiased; }
        .app-container { display: flex; min-height: 100vh; width: 100%; overflow-x: hidden; }

        /* Sidebar Wall */
        aside {
            width: var(--sidebar-w); min-width: var(--sidebar-w);
            background: var(--card-bg); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 16px; box-sizing: border-box;
            height: 100vh; position: sticky; top: 0;
        }
        @media (max-width: 1023px) {
            aside { position: fixed; left: 0; top: 0; bottom: 0; z-index: 2000; transform: translateX(-100%); transition: 0.3s; }
            aside.open { transform: translateX(0); }
        }

        .main-content { flex: 1; min-width: 0; display: flex; flex-direction: column; }
        header { height: 60px; background: var(--card-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        main { padding: 20px; box-sizing: border-box; width: 100%; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .glass-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }

        .workspace-layout { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 1200px) { .workspace-layout { grid-template-columns: 4fr 6fr; } }

        textarea { width: 100%; min-height: 200px; padding: 15px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-app); color: var(--text-main); font-size: 15px; resize: vertical; box-sizing: border-box; }

        /* NEW: Search Bar Styling */
        .search-container { margin-bottom: 12px; }
        .search-input { 
            width: 100%; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border); 
            background: var(--bg-app); color: var(--text-main); outline: none; font-size: 14px;
        }
        .search-input:focus { border-color: var(--brand); box-shadow: 0 0 0 2px var(--accent-bg); }

        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { text-align: left; padding: 15px; color: var(--text-muted); border-bottom: 2px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); }
        .num { font-family: monospace; text-align: right; font-weight: 500; }
        .model-name { color: var(--brand); cursor: pointer; font-weight: 600; text-decoration: underline; }

        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-bg.active { display: flex; }
        .modal { background: var(--card-bg); padding: 24px; border-radius: 12px; width: 350px; border: 1px solid var(--border); }

        .btn { padding: 8px 14px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; font-size: 13px; font-weight: 500; }
        .token-span { padding: 2px 4px; border-radius: 4px; margin: 1px; display: inline-block; font-family: monospace; font-size: 11px; }
    </style>
</head>
<body>

<div id="info-modal" class="modal-bg" onclick="this.classList.remove('active')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3 id="m-title" style="margin:0 0 10px 0;">Model Info</h3>
        <p id="m-desc" style="font-size:14px; color:var(--text-muted); line-height:1.5;"></p>
        <button class="btn" style="width:100%; background:var(--brand); color:white; border:none;" onclick="document.getElementById('info-modal').classList.remove('active')">Close</button>
    </div>
</div>

<div class="app-container">
    <aside id="sidebar">
        <h3 style="margin:0 0 15px 0; color:var(--brand);">GPT Calc</h3>
        <div id="history-list" style="flex:1; overflow-y:auto; font-size:11px;"></div>
        <button class="btn" style="background:var(--brand); color:white; border:none; margin-bottom:8px;" onclick="saveToHistory()">ðŸ’¾ Save</button>
        <button class="btn" style="color:#ef4444; border-color:#fee2e2" onclick="clearHistory()">ðŸ—‘ Clear History</button>
    </aside>

    <div class="main-content">
        <header>
            <div style="display:flex; gap:10px; align-items:center;">
                <button class="btn" onclick="document.getElementById('sidebar').classList.toggle('open')">â˜°</button>
                <select id="ratio" onchange="calculate()" class="btn">
                    <option value="1">1:1 Chat</option>
                    <option value="0.2">1:0.2 Summary</option>
                    <option value="3">1:3 Creative</option>
                </select>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="jokeExample()">ðŸŽ­ Humor</button>
                <button class="btn" onclick="clearEditor()" style="color:#ef4444">Clear Editor</button>
                <select id="curr" onchange="calculate()" class="btn">
                    <option value="USD">$ USD</option><option value="EUR">â‚¬ EUR</option>
                </select>
            </div>
        </header>

        <main>
            <div class="stats-grid">
                <div class="glass-card"><small style="font-weight:700;">TOKENS IN</small><div id="in-count" style="font-size:24px; font-weight:800; margin-top:5px;">0</div></div>
                <div class="glass-card" style="border-left: 4px solid var(--brand);"><small style="font-weight:700;">TOTAL COST</small><div id="total-cost" style="font-size:24px; font-weight:800; color:var(--brand); margin-top:5px;">$0.00</div></div>
            </div>

            <div class="workspace-layout">
                <div>
                    <textarea id="input" placeholder="Paste text here..." oninput="calculate()"></textarea>
                    <div id="viz" class="glass-card" style="margin-top:15px; min-height:80px;"></div>
                </div>
                <div class="glass-card" style="padding:15px; overflow-x:auto;">
                    <div class="search-container">
                        <input type="text" id="modelSearch" class="search-input" placeholder="ðŸ” Search models (e.g. GPT, Gemini)..." oninput="calculate()">
                    </div>
                    
                    <table>
                        <thead style="background:var(--bg-app)">
                            <tr><th>Model</th><th class="num">In</th><th class="num">Out</th><th class="num">Total</th></tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
</div>

<script src="https://unpkg.com/gpt-tokenizer/dist/cl100k_base.js"></script>
<script>
    let models = [];

    const jokes = [
        "Why did the AI go to the party? Because it heard they were serving 'chips'.",
        "How do you stop an AI from charging? You take away its credit card.",
        "My AI's favorite band? The Neural Network-ing."
    ];

    async function init() {
        try {
            const response = await fetch('models.json');
            models = await response.json();
            renderHistory();
            calculate();
        } catch (e) {
            console.error("Error loading models.json");
            models = [{name: "No Models Found", input: 0, output: 0}];
            calculate();
        }
    }

    function jokeExample() {
        document.getElementById('input').value = jokes[Math.floor(Math.random() * jokes.length)];
        calculate();
    }

    function clearEditor() {
        document.getElementById('input').value = '';
        calculate();
    }

    function calculate() {
        const text = document.getElementById('input').value;
        const searchTerm = document.getElementById('modelSearch').value.toLowerCase();
        const tokens = text ? GPTTokenizer_cl100k_base.encode(text) : [];
        const count = tokens.length;
        const ratio = parseFloat(document.getElementById('ratio').value);
        
        document.getElementById('in-count').innerText = count.toLocaleString();
        
        let html = ''; let totalSum = 0; let visibleCount = 0;

        models.forEach(m => {
            // Check if model matches search filter
            if (m.name.toLowerCase().includes(searchTerm)) {
                const costIn = (count / 1000000) * m.input;
                const costOut = ((count * ratio) / 1000000) * m.output;
                const total = costIn + costOut;
                totalSum += total;
                visibleCount++;
                
                html += `<tr>
                    <td class="model-name" onclick="showInfo('${m.name}')">${m.name}</td>
                    <td class="num">$${costIn.toFixed(4)}</td>
                    <td class="num">$${costOut.toFixed(4)}</td>
                    <td class="num" style="font-weight:bold; color:var(--brand); background:var(--accent-bg)">$${total.toFixed(4)}</td>
                </tr>`;
            }
        });
        
        document.getElementById('table-body').innerHTML = html || '<tr><td colspan="4" style="text-align:center; padding:20px;">No models match your search.</td></tr>';
        
        // Average total cost based on what's visible
        document.getElementById('total-cost').innerText = '$' + (visibleCount ? (totalSum / visibleCount).toFixed(4) : "0.00");
        
        // Token Visualizer
        const viz = document.getElementById('viz');
        viz.innerHTML = '<small style="display:block;margin-bottom:8px;color:var(--text-muted)">Token Visualization:</small>';
        tokens.slice(0, 100).forEach((t, i) => {
            const s = document.createElement('span'); s.className = 'token-span';
            s.style.background = `var(--t${(i % 4) + 1})`;
            s.textContent = GPTTokenizer_cl100k_base.decode([t]);
            viz.appendChild(s);
        });
    }

    function showInfo(name) {
        const m = models.find(x => x.name === name);
        if(!m) return;
        document.getElementById('m-title').innerText = m.name;
        document.getElementById('m-desc').innerText = m.info || "Technical specs for " + m.name + " are not yet listed.";
        document.getElementById('info-modal').classList.add('active');
    }

    function saveToHistory() {
        const text = document.getElementById('input').value;
        if(!text) return;
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        h.unshift({t: text, d: new Date().toLocaleTimeString()});
        localStorage.setItem('h', JSON.stringify(h.slice(0,10)));
        renderHistory();
    }

    function renderHistory() {
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        document.getElementById('history-list').innerHTML = h.length ? h.map(i => `
            <div style="padding:8px; border-bottom:1px solid var(--border); cursor:pointer; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;" onclick="document.getElementById('input').value='${i.t.replace(/'/g, "\\'")}';calculate();">
                <b>${i.d}</b>: ${i.t}
            </div>
        `).join('') : '<p style="padding:10px; color:var(--text-muted)">No history saved.</p>';
    }

    function clearHistory() {
        if(confirm("Wipe all saved work?")) {
            localStorage.removeItem('h');
            renderHistory();
        }
    }

    init();
</script>
</body>
</html>
