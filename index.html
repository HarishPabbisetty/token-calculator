<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Calculator Pro - 2026 Strategy Edition</title>
    <style>
        :root {
            --sidebar-w: 260px; --brand: #2563eb; --bg-app: #f8fafc;
            --card-bg: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
            --border: #e2e8f0; --accent-bg: #f0f7ff; --success: #22c55e;
            --t1: #dbeafe; --t2: #fef3c7; --t3: #dcfce7; --t4: #f3e8ff;
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg-app: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9; --text-muted: #94a3b8; --border: #334155; --accent-bg: #1e293b; }
        }
        
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); display: flex; min-height: 100vh; width: 100vw; overflow-x: hidden; }

        /* Sidebar Drawer Logic */
        aside { 
            width: var(--sidebar-w); background: var(--card-bg); border-right: 1px solid var(--border); 
            padding: 20px; display: flex; flex-direction: column; height: 100vh; 
            position: fixed; left: 0; top: 0; z-index: 2000;
            transform: translateX(-100%); transition: transform 0.3s ease;
            box-sizing: border-box;
        }
        aside.open { transform: translateX(0); }
        
        /* Overlay for mobile when menu is open */
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 1500; backdrop-filter: blur(2px); }

        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; width: 100%; transition: margin-left 0.3s ease; }
        
        header { height: 70px; background: var(--card-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; box-sizing: border-box; position: sticky; top: 0; z-index: 100; }
        main { padding: 20px; width: 100%; box-sizing: border-box; max-width: 1200px; margin: 0 auto; }

        .menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-main); padding: 5px; display: flex; align-items: center; }

        #compare-banner { display: none; background: var(--accent-bg); border: 1px solid var(--brand); border-radius: 12px; padding: 16px; margin-bottom: 20px; position: relative; }
        .close-banner { position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 20px; color: var(--text-muted); }
        .compare-split { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 10px; font-size: 12px; }
        .compare-box { background: var(--card-bg); border: 1px dashed var(--border); padding: 10px; border-radius: 8px; white-space: pre-wrap; max-height: 120px; overflow-y: auto; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 25px; }
        .glass-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 18px; box-sizing: border-box; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        
        textarea { width: 100%; min-height: 200px; padding: 18px; border-radius: 12px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text-main); font-size: 15px; resize: vertical; box-sizing: border-box; margin-bottom: 15px; outline: none; transition: border-color 0.2s; }
        textarea:focus { border-color: var(--brand); }
        
        .token-group { display: inline-flex; flex-direction: column; align-items: center; margin: 3px; }
        .token-idx { font-size: 9px; color: var(--text-muted); font-family: monospace; }
        .token-span { padding: 3px 6px; border-radius: 5px; font-family: monospace; font-size: 12px; white-space: pre; }
        
        .table-wrap { overflow-x: auto; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 600px; }
        th, td { text-align: left; padding: 14px; border-bottom: 1px solid var(--border); }
        th { background: var(--bg-app); font-weight: 600; }
        .num { font-family: monospace; text-align: right; }
        
        .btn { padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; font-size: 13px; font-weight: 600; color: var(--text-main); transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn:hover { background: var(--bg-app); border-color: var(--brand); }
        
        .why-tag { font-size: 10px; color: var(--brand); background: var(--accent-bg); padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 6px; border-left: 3px solid var(--brand); font-weight: 600; }

        /* Tablet/Desktop Adjustments */
        @media (min-width: 1024px) {
            aside { transform: translateX(0); position: sticky; }
            .menu-btn { display: none; }
            #overlay { display: none !important; }
        }
    </style>
</head>
<body>

<div id="overlay" onclick="toggleMenu()"></div>

<aside id="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="color:var(--brand); margin:0;">Settings</h3>
        <button class="menu-btn" onclick="toggleMenu()" style="font-size: 18px;">‚úï</button>
    </div>
    
    <div style="flex:1; overflow-y:auto;">
        <small style="color:var(--text-muted); font-weight:700; text-transform:uppercase; letter-spacing:1px;">Recent History</small>
        <div id="history-list" style="margin-top:10px; font-size:12px;"></div>
    </div>

    <div style="display:flex; flex-direction:column; gap:8px; padding-top:20px; border-top:1px solid var(--border);">
        <button class="btn" style="background:var(--brand); color:white; border:none;" onclick="downloadData()">üì• Download JSON</button>
        <button class="btn" style="background:var(--success); color:white; border:none;" onclick="saveToHistory()">üíæ Save Text</button>
        <button class="btn" onclick="clearHistory()" style="color:var(--danger)">üóë Clear History</button>
    </div>
</aside>

<div class="main-content">
    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <button class="menu-btn" onclick="toggleMenu()">‚ò∞</button>
            <select id="ratio" onchange="calculate()" class="btn">
                <option value="0.2">üí¨ Short Reply</option>
                <option value="1" selected>üîÑ Balanced</option>
                <option value="3">‚úçÔ∏è Creative</option>
            </select>
        </div>
        <div id="total-cost-head" style="font-size:24px; font-weight:800; color:var(--brand);">$0.00</div>
    </header>

    <main>
        <div id="compare-banner">
            <span class="close-banner" onclick="hideBanner()">√ó</span>
            <div style="display:flex; justify-content:space-between; align-items:center; padding-right: 35px; flex-wrap: wrap; gap:10px;">
                <span id="compare-text" style="font-weight:700; color:var(--brand);"></span>
                <button class="btn" onclick="undoOptimize()" style="padding: 5px 10px; font-size:11px;">‚Ü© Undo</button>
            </div>
            <div class="compare-split">
                <div><small style="color:var(--text-muted)">ORIGINAL</small><div id="old-text-view" class="compare-box"></div></div>
                <div><small style="color:var(--brand)">OPTIMIZED</small><div id="new-text-view" class="compare-box"></div></div>
            </div>
        </div>

        <div class="stats-grid">
            <div class="glass-card"><small style="font-weight:700;">TOKENS IN</small><div id="in-count" style="font-size:24px; font-weight:800; margin-top:5px;">0</div></div>
            <div class="glass-card"><small style="font-weight:700; color:#60a5fa;">EST. OUTPUT</small><div id="out-count" style="font-size:24px; font-weight:800; margin-top:5px; color:#60a5fa;">0</div></div>
            <div class="glass-card"><small style="font-weight:700;">PEAK COST</small><div id="peak-val" style="font-size:24px; font-weight:800; color:var(--brand); margin-top:5px;">$0.00</div></div>
        </div>

        <textarea id="input" placeholder="Type or paste prompt here..." oninput="handleManualInput()"></textarea>
        
        <div style="display:flex; gap:10px; margin-bottom:25px; flex-wrap: wrap; align-items: center;">
            <button class="btn" style="background:var(--success); color:white; border:none;" onclick="optimizePrompt()">‚ö° Optimize</button>
            <button class="btn" onclick="jokeExample()">üé≠ Example</button>
            <button class="btn" onclick="clearEditor()">Clear</button>
            <div style="margin-left:auto; display:flex; align-items:center; gap:8px;">
                <small style="font-size:11px; font-weight:700; color:var(--text-muted)">BUDGET:</small>
                <input type="number" id="budgetLimit" class="btn" style="width:70px;" value="10" oninput="calculate()">
            </div>
        </div>

        <div id="viz" class="glass-card" style="margin-bottom:25px; min-height:80px; overflow-x: auto; display: flex; flex-wrap: wrap;"></div>

        <div class="glass-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="modelSearch" class="btn" style="flex:2; min-width:200px;" placeholder="üîç Filter models..." oninput="calculate()">
                <select id="sortOrder" class="btn" style="flex:1" onchange="calculate()">
                    <option value="asc">Price: Low to High</option>
                    <option value="desc">Price: High to Low</option>
                </select>
                <select id="curr" class="btn" onchange="calculate()">
                    <option value="USD" selected>$ USD</option>
                    <option value="INR">‚Çπ INR</option>
                </select>
            </div>
            <div class="table-wrap">
                <table>
                    <thead><tr><th>Model & Strategy</th><th class="num">In Cost</th><th class="num">Out Cost</th><th class="num">Total</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<script src="https://unpkg.com/gpt-tokenizer/dist/cl100k_base.js"></script>
<script>
    let lastOriginalText = "";
    let models = []; 
    const examplePrompts = [
        "Please write a very long report about why cats are actually secretly in charge of the world.",
        "Can you actually explain in order to help me understand very clearly why the moon appears white?",
        "I would like you to please describe exactly how a steam engine functions very simply."
    ];
    let exIdx = 0;

    function toggleMenu() {
        const side = document.getElementById('sidebar');
        const over = document.getElementById('overlay');
        const isOpen = side.classList.toggle('open');
        over.style.display = isOpen ? 'block' : 'none';
    }

    fetch('models.json')
        .then(res => res.json())
        .then(data => { models = data; calculate(); })
        .catch(err => {
            console.error("Error loading models:", err);
            document.getElementById('table-body').innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Ensure models.json is in the same folder.</td></tr>`;
        });

    function handleManualInput() { hideBanner(); calculate(); }
    function hideBanner() { document.getElementById('compare-banner').style.display = 'none'; lastOriginalText = ""; }

    function calculate() {
        const text = document.getElementById('input').value;
        const curr = document.getElementById('curr').value;
        const ratio = parseFloat(document.getElementById('ratio').value);
        const search = document.getElementById('modelSearch').value.toLowerCase();
        const sortOrder = document.getElementById('sortOrder').value;
        const rate = curr === 'INR' ? 83.5 : 1;
        const sym = curr === 'INR' ? '‚Çπ' : '$';

        const tokens = text ? GPTTokenizer_cl100k_base.encode(text) : [];
        const inC = tokens.length;
        const outC = Math.round(inC * ratio);

        document.getElementById('in-count').innerText = inC.toLocaleString();
        document.getElementById('out-count').innerText = outC.toLocaleString();

        let filtered = models.filter(m => 
            m.name.toLowerCase().includes(search) || m.why.toLowerCase().includes(search)
        ).map(m => {
            const costIn = (inC / 1000000) * m.input * rate;
            const costOut = (outC / 1000000) * m.output * rate;
            const total = costIn + costOut;
            return { ...m, costIn, costOut, total };
        });

        filtered.sort((a,b) => sortOrder === 'desc' ? b.total - a.total : a.total - b.total);

        let html = ''; let peak = 0;
        filtered.forEach(m => {
            if (m.total > peak) peak = m.total;
            html += `<tr>
                <td><b>${m.name}</b><br><small>Limit: ${m.limit/1000}K</small><br><span class="why-tag">üí° ${m.why}</span></td>
                <td class="num">${sym}${m.costIn.toFixed(4)}</td>
                <td class="num" style="color:#60a5fa">${sym}${m.costOut.toFixed(4)}</td>
                <td class="num" style="color:var(--brand); font-weight:800;">${sym}${m.total.toFixed(2)}</td>
            </tr>`;
        });

        document.getElementById('table-body').innerHTML = html;
        document.getElementById('total-cost-head').innerText = sym + peak.toFixed(2);
        document.getElementById('peak-val').innerText = sym + peak.toFixed(2);
        renderViz(tokens);
    }

    function downloadData() {
        const text = document.getElementById('input').value;
        if(!text) return alert("Enter text first.");
        const exportObj = { timestamp: new Date().toISOString(), prompt: text, total_cost: document.getElementById('total-cost-head').innerText };
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
        const link = document.createElement('a'); link.setAttribute("href", dataStr);
        link.setAttribute("download", `analysis-${Date.now()}.json`); link.click();
    }

    function renderViz(tokens) {
        const viz = document.getElementById('viz');
        viz.innerHTML = tokens.length ? '' : '<small style="color:var(--text-muted)">Token index visualization...</small>';
        tokens.slice(0, 50).forEach((t, i) => {
            const g = document.createElement('div'); g.className = 'token-group';
            g.innerHTML = `<span class="token-idx">${i+1}</span><span class="token-span" style="background:var(--t${(i%4)+1})">${GPTTokenizer_cl100k_base.decode([t])}</span>`;
            viz.appendChild(g);
        });
    }

    function optimizePrompt() {
        const input = document.getElementById('input'); if(!input.value) return;
        const currentText = input.value;
        const optimized = currentText.replace(/\b(Please|Actually|Very|I would like you to|Can you|I want you to|In order to)\b/gi, '').replace(/\s+/g, ' ').trim();
        if (optimized === currentText) return;
        lastOriginalText = currentText; input.value = optimized;
        const saved = GPTTokenizer_cl100k_base.encode(lastOriginalText).length - GPTTokenizer_cl100k_base.encode(optimized).length;
        document.getElementById('compare-banner').style.display = 'block';
        document.getElementById('compare-text').innerText = `‚ú® Saved ${saved} Tokens!`;
        document.getElementById('old-text-view').innerText = lastOriginalText;
        document.getElementById('new-text-view').innerText = optimized;
        calculate();
    }

    function jokeExample() { hideBanner(); document.getElementById('input').value = examplePrompts[exIdx]; exIdx = (exIdx + 1) % examplePrompts.length; calculate(); }
    function clearEditor() { document.getElementById('input').value = ''; hideBanner(); calculate(); }
    function undoOptimize() { if(lastOriginalText) { document.getElementById('input').value = lastOriginalText; hideBanner(); calculate(); } }
    
    function saveToHistory() {
        const txt = document.getElementById('input').value; if(!txt) return;
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        h.unshift({t: txt, d: new Date().toLocaleTimeString()});
        localStorage.setItem('h', JSON.stringify(h.slice(0,10)));
        renderHistory();
    }
    
    function renderHistory() {
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        document.getElementById('history-list').innerHTML = h.map(i => `
            <div style="padding:10px; border-bottom:1px solid var(--border); cursor:pointer;" onclick="document.getElementById('input').value='${i.t.replace(/'/g, "\\'")}';calculate();if(window.innerWidth < 1024) toggleMenu();">
                <div style="font-weight:700; color:var(--brand);">${i.d}</div>
                <div style="white-space:nowrap; overflow:hidden; text-overflow:ellipsis; opacity:0.8;">${i.t}</div>
            </div>`).join('') || '<div style="padding:10px; opacity:0.5;">No history saved.</div>';
    }
    
    function clearHistory() { if(confirm("Clear history?")) { localStorage.removeItem('h'); renderHistory(); } }
    renderHistory();
</script>
</body>
</html>
