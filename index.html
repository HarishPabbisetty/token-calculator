<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Calculator Pro v1.2.7</title>
    <style>
        :root {
            --sidebar-w: 260px; --brand: #2563eb; --bg-app: #f8fafc;
            --card-bg: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
            --border: #e2e8f0; --accent-bg: #f0f7ff; --success: #22c55e;
            --danger: #ef4444; 
            --t1: #dbeafe; --t2: #fef3c7; --t3: #dcfce7; --t4: #f3e8ff;
            --token-text: #1e293b;
        }
        @media (prefers-color-scheme: dark) {
            :root { 
                --bg-app: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9; 
                --text-muted: #94a3b8; --border: #334155; --accent-bg: #1e293b; 
                --t1: rgba(59, 130, 246, 0.3); --t2: rgba(245, 158, 11, 0.3); 
                --t3: rgba(16, 185, 129, 0.3); --t4: rgba(139, 92, 246, 0.3);
                --token-text: #ffffff;
            }
        }
        
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); display: flex; min-height: 100vh; overflow: hidden; }
        
        aside { 
            width: var(--sidebar-w); min-width: var(--sidebar-w); background: var(--card-bg); border-right: 1px solid var(--border); 
            padding: 16px; display: flex; flex-direction: column; height: 100vh; 
            position: fixed; left: 0; top: 0; z-index: 2000;
            transition: transform 0.3s ease; transform: translateX(-100%);
            box-sizing: border-box;
        }
        aside.open { transform: translateX(0); }
        
        .main-content { 
            flex: 1; display: flex; flex-direction: column; width: 100vw; 
            transition: margin-left 0.3s ease, width 0.3s ease; margin-left: 0; 
        }

        @media (min-width: 1025px) {
            aside.open ~ .main-content { margin-left: var(--sidebar-w); width: calc(100vw - var(--sidebar-w)); }
            aside.open { transform: translateX(0); }
        }

        header { height: 60px; background: var(--card-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; flex-shrink: 0; }
        .menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-main); margin-right: 15px; }

        .split-container { display: grid; grid-template-columns: 1.2fr 1.1fr; gap: 20px; padding: 20px; overflow-y: auto; height: 100%; box-sizing: border-box; }
        @media (max-width: 1024px) { .split-container { grid-template-columns: 1fr; } }

        .glass-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px; margin-bottom: 15px; }
        textarea { width: 100%; min-height: 200px; padding: 15px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-app); color: var(--text-main); font-size: 14px; outline: none; box-sizing: border-box; resize: vertical; }
        
        .viz-sub { display: flex; flex-wrap: wrap; gap: 4px; padding-top: 10px; }
        .token-group { display: inline-flex; flex-direction: column; align-items: center; margin: 2px; }
        .token-idx { font-size: 10px; color: var(--brand); font-family: monospace; font-weight: bold; margin-bottom: 2px; }
        .token-span { padding: 3px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; color: var(--token-text); border: 1px solid rgba(128,128,128,0.1); }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border); }
        .num { font-family: monospace; text-align: right; font-weight: 700; color: var(--brand); }
        .why-tag { font-size: 10px; color: var(--brand); background: var(--accent-bg); padding: 4px 8px; border-radius: 4px; display: block; margin-top: 4px; border-left: 3px solid var(--brand); font-weight: bold; }

        .btn { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; font-size: 13px; display: inline-flex; align-items: center; gap: 6px; color: var(--text-main); font-weight: 500; }
        .btn-success { background: var(--success); color: white; border: none; }
        .btn-primary { background: var(--brand); color: white; border: none; }
    </style>
</head>
<body>

<aside id="sidebar" class="open">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="color:var(--brand); margin:0;">Token Calc</h3>
        <button onclick="toggleMenu()" style="background:none; border:none; cursor:pointer; font-size:20px;">âœ•</button>
    </div>

    <div style="display:flex; flex-direction:column; gap:8px; padding-bottom:15px; border-bottom:1px solid var(--border);">
        <button class="btn btn-primary" onclick="downloadData()">ðŸ“¥ Download JSON</button>
        <button class="btn btn-success" onclick="saveToHistory()">ðŸ’¾ Cache Request</button>
        <button class="btn" onclick="clearHistory()" style="color:var(--danger)">ðŸ—‘ Clear History</button>
    </div>

    <div id="history-list" style="flex:1; overflow-y:auto; margin-top:15px; font-size:11px;"></div>
</aside>

<div class="main-content" id="mainContent">
    <header>
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        <h2 style="font-size: 18px; margin: 0;">2026 Strategy Engine</h2>
    </header>

    <div class="split-container">
        <div class="left-panel">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; margin-bottom: 15px;">
                <div class="glass-card" style="margin:0;"><small>TOKENS</small><div id="in-count" style="font-size:20px; font-weight:700;">0</div></div>
                <div class="glass-card" style="margin:0;"><small>PEAK COST</small><div id="peak-val" style="font-size:20px; font-weight:700; color:var(--brand);">$0.00</div></div>
                <div class="glass-card" style="margin:0;"><small>BUDGET</small>
                    <input type="number" id="budgetLimit" style="width:100%; border:none; background:transparent; font-size:20px; font-weight:700; color:var(--danger); outline:none;" step="0.01" value="0.10" oninput="calculate()">
                </div>
            </div>

            <textarea id="input" placeholder="Type prompt here..." oninput="calculate()"></textarea>
            
            <div style="display:flex; gap:8px; margin: 10px 0;">
                <button class="btn btn-success" onclick="optimizePrompt()">âš¡ Optimize</button>
                <button class="btn" onclick="jokeExample()">ðŸŽ­ Example</button>
                <button class="btn" onclick="clearEditor()">Clear</button>
            </div>

            <div id="viz" class="glass-card">
                <div id="viz-content" class="viz-sub">
                    <small style="color:var(--text-muted)">Tokenization preview...</small>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="glass-card">
                <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap: wrap;">
                    <input type="text" id="modelSearch" class="btn" style="flex:1; min-width: 120px;" placeholder="ðŸ” Filter..." oninput="calculate()">
                    <select id="sortOrder" class="btn" onchange="calculate()">
                        <option value="asc">Price: Low to High</option>
                        <option value="desc">Price: High to Low</option>
                    </select>
                    <select id="curr" class="btn" onchange="calculate()">
                        <option value="USD" selected>$ USD</option>
                        <option value="INR">â‚¹ INR</option>
                    </select>
                </div>
                <div style="overflow-x:auto;">
                    <table>
                        <thead><tr><th>Model & Strategy</th><th class="num">In Cost</th></tr></thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/gpt-tokenizer/dist/cl100k_base.js"></script>
<script>
    let models = [];
    let lastOptimized = null;
    let exIdx = 0;
    const examples = [
        "Please write a very long report about why cats are actually secretly in charge of the world.",
        "Can you actually explain in order to help me understand very clearly why the moon appears white?",
        "I would like you to please describe exactly how a steam engine functions very simply."
    ];

    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }

    fetch('models.json').then(r => r.json()).then(d => { models = d; calculate(); });

    function calculate() {
        const text = document.getElementById('input').value;
        const rate = document.getElementById('curr').value === 'INR' ? 83.5 : 1;
        const sym = document.getElementById('curr').value === 'INR' ? 'â‚¹' : '$';
        const search = document.getElementById('modelSearch').value.toLowerCase();
        const sort = document.getElementById('sortOrder').value;
        const budget = parseFloat(document.getElementById('budgetLimit').value) || 0;

        const tokens = text ? GPTTokenizer_cl100k_base.encode(text) : [];
        document.getElementById('in-count').innerText = tokens.length.toLocaleString();

        let filtered = models.filter(m => m.name.toLowerCase().includes(search) || m.why.toLowerCase().includes(search))
            .map(m => {
                const cost = (tokens.length / 1000000) * m.input * rate;
                return { ...m, cost };
            });

        filtered.sort((a,b) => sort === 'desc' ? b.cost - a.cost : a.cost - b.cost);

        let peak = 0;
        let html = filtered.map(m => {
            if (m.cost > peak) peak = m.cost;
            const isOver = m.cost > (budget * rate);
            return `<tr class="${isOver ? 'over-budget' : ''}">
                <td><b>${m.name}</b><span class="why-tag">ðŸ’¡ ${m.why}</span></td>
                <td class="num" style="color:${isOver ? 'var(--danger)' : 'var(--brand)'}">${sym}${m.cost.toFixed(6)}</td>
            </tr>`;
        }).join('');

        document.getElementById('table-body').innerHTML = html;
        document.getElementById('peak-val').innerText = sym + peak.toFixed(4);
        if(!lastOptimized) renderTokens(tokens, "viz-content");
    }

    function renderTokens(tokens, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = tokens.length ? '' : '<small>Tokenization preview...</small>';
        tokens.slice(0, 100).forEach((t, i) => {
            const g = document.createElement('div'); g.className = 'token-group';
            // UPDATED: Now shows sequential numbering (1, 2, 3...)
            g.innerHTML = `<span class="token-idx">${i + 1}</span><span class="token-span" style="background:var(--t${(i%4)+1})">${GPTTokenizer_cl100k_base.decode([t])}</span>`;
            container.appendChild(g);
        });
    }

    function optimizePrompt() {
        const input = document.getElementById('input'); if(!input.value) return;
        const original = input.value;
        const optimized = original.replace(/\b(Please|Actually|Very|Can you|exactly|simply)\b/gi, '').replace(/\s+/g, ' ').trim();
        input.value = optimized;
        const oldT = GPTTokenizer_cl100k_base.encode(original);
        const newT = GPTTokenizer_cl100k_base.encode(optimized);
        document.getElementById('viz').innerHTML = `
            <div style="font-size:10px; font-weight:bold; color:var(--danger); border-bottom:1px solid var(--border); padding-bottom:4px; text-transform:uppercase;">Before Optimization (${oldT.length} Tokens)</div>
            <div id="v-old" class="viz-sub"></div>
            <div style="font-size:10px; font-weight:bold; color:var(--success); margin-top:12px; border-bottom:1px solid var(--border); padding-bottom:4px; text-transform:uppercase;">After Optimization (${newT.length} Tokens)</div>
            <div id="v-new" class="viz-sub"></div>
        `;
        renderTokens(oldT, 'v-old'); renderTokens(newT, 'v-new');
        lastOptimized = true; calculate();
    }

    function jokeExample() { resetViz(); document.getElementById('input').value = examples[exIdx]; exIdx = (exIdx + 1) % examples.length; calculate(); }
    function clearEditor() { resetViz(); document.getElementById('input').value = ''; calculate(); }
    function resetViz() { lastOptimized = null; document.getElementById('viz').innerHTML = '<div id="viz-content" class="viz-sub"><small>Tokenization preview...</small></div>'; }

    function downloadData() {
        const text = document.getElementById('input').value;
        const tokens = GPTTokenizer_cl100k_base.encode(text);
        const data = { timestamp: new Date().toISOString(), prompt: text, token_count: tokens.length, token_ids: tokens };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `audit-${Date.now()}.json`; a.click();
    }

    function saveToHistory() {
        const txt = document.getElementById('input').value; if(!txt) return;
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        h.unshift({t: txt, d: new Date().toLocaleTimeString()});
        localStorage.setItem('h', JSON.stringify(h.slice(0,10)));
        renderHistory();
    }

    function renderHistory() {
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        document.getElementById('history-list').innerHTML = h.map(i => `<div style="padding:10px; border-bottom:1px solid var(--border); cursor:pointer;" onclick="document.getElementById('input').value=\`${i.t.replace(/`/g, '\\`')}\`;resetViz();calculate()">${i.d}: ${i.t.substring(0,25)}...</div>`).join('') || 'No history';
    }

    function clearHistory() { localStorage.removeItem('h'); renderHistory(); }
    renderHistory();
</script>
</body>
</html>
