<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Calculator Pro</title>
    <style>
        :root {
            --sidebar-w: 240px; --brand: #2563eb; --bg-app: #f8fafc;
            --card-bg: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
            --border: #e2e8f0; --accent-bg: #f0f7ff; --success: #22c55e;
            --danger: #ef4444; 
            --t1: #dbeafe; --t2: #fef3c7; --t3: #dcfce7; --t4: #f3e8ff;
        }
        @media (prefers-color-scheme: dark) {
            :root { --bg-app: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9; --text-muted: #94a3b8; --border: #334155; --accent-bg: #1e293b; }
        }
        
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg-app); color: var(--text-main); display: flex; min-height: 100vh; overflow-x: hidden; }
        
        aside { 
            width: var(--sidebar-w); min-width: var(--sidebar-w); background: var(--card-bg); border-right: 1px solid var(--border); 
            padding: 16px; display: flex; flex-direction: column; height: 100vh; 
            position: fixed; left: 0; top: 0; z-index: 2000;
            transform: translateX(-100%); transition: transform 0.3s ease;
            box-sizing: border-box;
        }
        aside.open { transform: translateX(0); }
        #overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1500; backdrop-filter: blur(2px); }

        .main-content { flex: 1; display: flex; flex-direction: column; width: 100%; margin-left: 0; transition: margin 0.3s; }
        header { height: 60px; background: var(--card-bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; position: sticky; top: 0; z-index: 100; }
        .menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-main); margin-right: 15px; }

        .split-container { 
            display: grid; 
            grid-template-columns: 1.2fr 1.1fr; 
            gap: 20px; 
            padding: 20px; 
            height: calc(100vh - 80px);
            max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box;
        }

        .left-panel, .right-panel { display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-bottom: 40px; }
        .left-panel::-webkit-scrollbar, .right-panel::-webkit-scrollbar { width: 0px; }

        .glass-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px; padding: 16px; box-sizing: border-box; }
        textarea { width: 100%; min-height: 180px; padding: 15px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-app); color: var(--text-main); font-size: 14px; resize: vertical; outline: none; }
        
        .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
        
        /* TOKEN VIZ: Integrated Comparison Layout */
        #viz { min-height: 120px; overflow: hidden; height: auto; }
        .viz-sub { display: flex; flex-wrap: wrap; align-content: flex-start; margin-bottom: 15px; }
        .viz-label { font-size: 10px; font-weight: bold; color: var(--brand); text-transform: uppercase; width: 100%; margin-bottom: 8px; border-bottom: 1px solid var(--border); padding-bottom: 4px;}
        
        .token-group { display: inline-flex; flex-direction: column; align-items: center; margin: 2px; }
        .token-idx { font-size: 8px; color: var(--text-muted); font-family: monospace; }
        .token-span { padding: 2px 4px; border-radius: 4px; font-family: monospace; font-size: 11px; white-space: pre; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid var(--border); }
        .num { font-family: monospace; text-align: right; font-weight: 700; }
        .over-budget { background-color: #fff1f2 !important; color: var(--danger) !important; }
        .why-tag { font-size: 10px; color: var(--brand); background: var(--accent-bg); padding: 4px 8px; border-radius: 4px; display: block; margin-top: 4px; font-weight: bold; border-left: 3px solid var(--brand); }

        .btn { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; font-size: 13px; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; color: var(--text-main); }
        .btn-success { background: var(--success); color: white; border: none; }
        .btn-primary { background: var(--brand); color: white; border: none; }

        @media (max-width: 1024px) { 
            .split-container { grid-template-columns: 1fr; height: auto; } 
            .stats-row { grid-template-columns: 1fr 1fr; }
        }
        @media (min-width: 1025px) { aside { transform: translateX(0); } .main-content { margin-left: var(--sidebar-w); } .menu-btn { display: none; } }
    </style>
</head>
<body>

<div id="overlay" onclick="toggleMenu()"></div>

<aside id="sidebar">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3 style="color:var(--brand); margin:0;">Token Calc</h3>
        <button class="menu-btn" onclick="toggleMenu()" style="font-size: 18px;">âœ•</button>
    </div>
    <div id="history-list" style="flex:1; overflow-y:auto; font-size:11px; margin-bottom: 15px;"></div>
    <div style="display:flex; flex-direction:column; gap:8px;">
        <button class="btn btn-primary" onclick="downloadData()">ðŸ“¥ Download JSON</button>
        <button class="btn btn-success" onclick="saveToHistory()">ðŸ’¾ Cache Request</button>
        <button class="btn" onclick="clearHistory()" style="color:var(--danger)">ðŸ—‘ Clear History</button>
    </div>
</aside>

<div class="main-content">
    <header>
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        <h2 style="font-size: 18px; margin: 0;">2026 Strategy Engine</h2>
    </header>

    <div class="split-container">
        <div class="left-panel">
            <div class="stats-row">
                <div class="glass-card"><small>TOKEN COUNT </small><div id="in-count" style="font-size:18px; font-weight:700;">0</div></div>
                <div class="glass-card"><small>PEAK COST</small><div id="peak-val" style="font-size:18px; font-weight:700; color:var(--brand);">$0.0000</div></div>
                <div class="glass-card"><small>BUDGET LIMIT</small>
                    <input type="number" id="budgetLimit" style="width:100%; border:none; background:transparent; font-size:18px; font-weight:700; color:var(--danger); outline:none;" step="0.01" value="0.10" oninput="calculate()">
                </div>
            </div>

            <textarea id="input" placeholder="Type prompt here..." oninput="calculate()"></textarea>
            
            <div style="display:flex; gap:8px; flex-wrap: wrap;">
                <button class="btn btn-success" onclick="optimizePrompt()">âš¡ Optimize Prompt</button>
                <button class="btn" onclick="jokeExample()">ðŸŽ­ Example</button>
                <button class="btn" onclick="clearEditor()">Clear</button>
            </div>

            <div id="viz" class="glass-card">
                <div id="viz-content">
                    <small style="color:var(--text-muted)">Tokenization preview will appear here...</small>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="glass-card" style="flex:1; display:flex; flex-direction:column;">
                <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap: wrap;">
                    <input type="text" id="modelSearch" class="btn" style="flex:1; min-width:130px;" placeholder="ðŸ” Filter models..." oninput="calculate()">
                    <select id="sortOrder" class="btn" onchange="calculate()">
                        <option value="asc">Price: Low to High</option>
                        <option value="desc">Price: High to Low</option>
                    </select>
                    <select id="curr" class="btn" onchange="calculate()">
                        <option value="USD" selected>$ USD</option>
                        <option value="INR">â‚¹ INR</option>
                    </select>
                </div>
                <div style="overflow-y:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Model & Strategy</th>
                                <th class="num">In Cost</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/gpt-tokenizer/dist/cl100k_base.js"></script>
<script>
    let models = []; 
    let lastOptimized = null; // Store previous state for comparison
    const examples = [
        "Please write a very long report about why cats are actually secretly in charge of the world.",
        "Can you actually explain in order to help me understand very clearly why the moon appears white?",
        "I would like you to please describe exactly how a steam engine functions very simply."
    ];
    let exIdx = 0;

    function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }

    fetch('models.json')
        .then(res => res.json())
        .then(data => { models = data; calculate(); })
        .catch(() => { document.getElementById('table-body').innerHTML = '<tr><td colspan="2">Check models.json.</td></tr>'; });

    function calculate() {
        const text = document.getElementById('input').value;
        const search = document.getElementById('modelSearch').value.toLowerCase();
        const sort = document.getElementById('sortOrder').value;
        const budget = parseFloat(document.getElementById('budgetLimit').value) || 0;
        const rate = document.getElementById('curr').value === 'INR' ? 83.5 : 1;
        const sym = document.getElementById('curr').value === 'INR' ? 'â‚¹' : '$';

        const tokens = text ? GPTTokenizer_cl100k_base.encode(text) : [];
        document.getElementById('in-count').innerText = tokens.length.toLocaleString();

        let filtered = models.filter(m => m.name.toLowerCase().includes(search) || m.why.toLowerCase().includes(search))
            .map(m => {
                const cost = (tokens.length / 1000000) * m.input * rate;
                return { ...m, cost };
            });

        filtered.sort((a,b) => sort === 'desc' ? b.cost - a.cost : a.cost - b.cost);

        let peak = 0;
        let html = filtered.map(m => {
            if (m.cost > peak) peak = m.cost;
            const isOver = m.cost > (budget * rate);
            return `<tr class="${isOver ? 'over-budget' : ''}">
                <td><b>${m.name}</b><span class="why-tag">ðŸ’¡ ${m.why}</span></td>
                <td class="num" style="color:${isOver ? 'var(--danger)' : 'var(--brand)'}">${sym}${m.cost.toFixed(6)}</td>
            </tr>`;
        }).join('');

        document.getElementById('table-body').innerHTML = html;
        document.getElementById('peak-val').innerText = sym + peak.toFixed(4);
        
        // Only render normal view if not in optimization mode
        if (!lastOptimized) {
            renderTokens(tokens, "viz-content");
        }
    }

    function optimizePrompt() {
        const input = document.getElementById('input');
        if(!input.value) return;
        
        const oldTokens = GPTTokenizer_cl100k_base.encode(input.value);
        const optimized = input.value
            .replace(/\b(Please|Actually|Very|Can you|I would like you to|exactly|simply)\b/gi, '')
            .replace(/\s+/g, ' ')
            .trim();
        
        const newTokens = GPTTokenizer_cl100k_base.encode(optimized);
        input.value = optimized;
        
        // Show comparison in the viz section
        const viz = document.getElementById('viz');
        viz.innerHTML = `
            <div class="viz-label" style="color:var(--danger)">Before Optimization (${oldTokens.length} Tokens)</div>
            <div id="viz-old" class="viz-sub"></div>
            <div class="viz-label" style="color:var(--success)">After Optimization (${newTokens.length} Tokens)</div>
            <div id="viz-new" class="viz-sub"></div>
        `;
        
        renderTokens(oldTokens, "viz-old");
        renderTokens(newTokens, "viz-new");
        
        lastOptimized = true; // Flag to stop normal calculate() from overwriting this view
        calculate();
    }

    function renderTokens(tokens, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = tokens.length ? '' : '<small style="color:var(--text-muted)">Tokenization preview...</small>';
        tokens.slice(0, 50).forEach((t, i) => {
            const g = document.createElement('div'); g.className = 'token-group';
            g.innerHTML = `<span class="token-idx">${i+1}</span><span class="token-span" style="background:var(--t${(i%4)+1})">${GPTTokenizer_cl100k_base.decode([t])}</span>`;
            container.appendChild(g);
        });
    }

    function jokeExample() { 
        resetViz();
        document.getElementById('input').value = examples[exIdx]; 
        exIdx = (exIdx + 1) % examples.length; 
        calculate(); 
    }
    
    function clearEditor() { 
        resetViz();
        document.getElementById('input').value = ''; 
        calculate(); 
    }

    function resetViz() {
        lastOptimized = null;
        document.getElementById('viz').innerHTML = '<div id="viz-content"><small style="color:var(--text-muted)">Tokenization preview...</small></div>';
    }
    
    // Standard history functions...
    function saveToHistory() {
        const txt = document.getElementById('input').value; if(!txt) return;
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        h.unshift({t: txt, d: new Date().toLocaleTimeString()});
        localStorage.setItem('h', JSON.stringify(h.slice(0,10)));
        renderHistory();
    }

    function renderHistory() {
        const h = JSON.parse(localStorage.getItem('h') || '[]');
        document.getElementById('history-list').innerHTML = h.map(i => `<div style="padding:10px; border-bottom:1px solid var(--border); cursor:pointer;" onclick="document.getElementById('input').value=\`${i.t.replace(/`/g, '\\`')}\`;resetViz();calculate()">${i.d}: ${i.t.substring(0,20)}...</div>`).join('') || 'No history';
    }

    function clearHistory() { if(confirm("Delete all history?")) { localStorage.removeItem('h'); renderHistory(); } }
    renderHistory();
</script>
</body>
</html>
