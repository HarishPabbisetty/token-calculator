<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Calculator Pro</title>
    <style>
        :root {
            --sidebar-w: 240px; 
            --brand: #2563eb; --bg-app: #f8fafc;
            --card-bg: #ffffff; --text-main: #1e293b; --text-muted: #64748b;
            --border: #e2e8f0; --danger: #ef4444; --success: #22c55e;
            --t1: #dbeafe; --t2: #fef3c7; --t3: #dcfce7; --t4: #f3e8ff;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-app: #0f172a; --card-bg: #1e293b; --text-main: #f1f5f9;
                --text-muted: #94a3b8; --border: #334155;
            }
        }
        
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: var(--bg-app); color: var(--text-main); }
        .app-container { display: flex; min-height: 100vh; }

        aside {
            width: var(--sidebar-w); background: var(--card-bg); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; padding: 20px; height: 100vh; position: sticky; top: 0;
        }

        .main-content { flex: 1; display: flex; flex-direction: column; padding: 20px; }
        .glass-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        
        textarea { width: 100%; min-height: 250px; padding: 15px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-app); color: var(--text-main); font-size: 16px; resize: vertical; box-sizing: border-box; margin-bottom: 20px; }

        /* Progress Bar Styling */
        .ctx-container { margin-top: 8px; width: 100%; }
        .ctx-bar-bg { width: 100%; height: 6px; background: #e2e8f0; border-radius: 10px; overflow: hidden; }
        .ctx-bar-fill { height: 100%; width: 0%; transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { text-align: left; padding: 12px; color: var(--text-muted); border-bottom: 2px solid var(--border); font-size: 12px; text-transform: uppercase; }
        td { padding: 14px 12px; border-bottom: 1px solid var(--border); vertical-align: top; }

        .num { font-family: 'JetBrains Mono', monospace; text-align: right; font-weight: 600; }
        .warning-text { color: var(--danger); font-size: 10px; font-weight: bold; margin-top: 2px; }
        .btn { padding: 10px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--card-bg); cursor: pointer; font-weight: 500; }
        .token-span { padding: 2px 4px; border-radius: 4px; margin: 1px; display: inline-block; font-family: monospace; font-size: 11px; }
    </style>
</head>
<body>

<div class="app-container">
    <aside>
        <h2 style="color:var(--brand); margin-top:0;">TokenCalc</h2>
        <div id="history-list" style="flex:1; overflow-y:auto; font-size:12px; margin: 20px 0;"></div>
        <button class="btn" style="background:var(--brand); color:white; border:none;" onclick="saveToHistory()">üíæ Save Snapshot</button>
    </aside>

    <div class="main-content">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <div style="display:flex; gap:10px;">
                <select id="curr" onchange="calculate()" class="btn"><option value="USD">$ USD</option><option value="INR">‚Çπ INR</option></select>
                <select id="ratio" onchange="calculate()" class="btn"><option value="1">1:1 Chat</option><option value="0.5">1:0.5 Summary</option></select>
                <select id="sortOrder" onchange="calculate()" class="btn">
                    <option value="desc">Price: High to Low</option>
                    <option value="asc">Price: Low to High</option>
                </select>
            </div>
            <div id="total-cost" style="font-size:28px; font-weight:800; color:var(--brand);">$0.00</div>
        </div>

        <textarea id="input" placeholder="Enter or paste your prompt here..." oninput="calculate()"></textarea>

        <div class="glass-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 style="margin:0;">Model Comparison</h3>
                <span id="in-count" style="background:var(--brand); color:white; padding:4px 12px; border-radius:20px; font-size:13px; font-weight:bold;">0 Tokens</span>
            </div>
            <table>
                <thead>
                    <tr><th>Model & Context Window</th><th class="num">In</th><th class="num">Out</th><th class="num">Total</th></tr>
                </thead>
                <tbody id="table-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/gpt-tokenizer/dist/cl100k_base.js"></script>
<script>
    let models = [];
    let exchangeRates = { USD: 1, INR: 83.5 };

    async function init() {
        try {
            // Added ?v=timestamp to bypass browser cache
            const modelRes = await fetch('models.json?v=' + Date.now());
            models = await modelRes.json();
        } catch(e) { console.error("Could not load models.json"); }
        calculate();
    }

    function calculate() {
        const text = document.getElementById('input').value;
        const tokens = text ? GPTTokenizer_cl100k_base.encode(text) : [];
        const count = tokens.length;
        const ratio = parseFloat(document.getElementById('ratio').value);
        const sortOrder = document.getElementById('sortOrder').value;
        const curr = document.getElementById('curr').value;
        
        document.getElementById('in-count').innerText = count.toLocaleString() + " Tokens";

        let results = models.map(m => {
            const costIn = (count / 1000000) * (m.input || 0);
            const costOut = ((count * ratio) / 1000000) * (m.output || 0);
            return { ...m, costIn, costOut, total: costIn + costOut };
        });

        if (sortOrder === 'desc') results.sort((a,b) => b.total - a.total);
        else results.sort((a,b) => a.total - b.total);

        let html = '';
        results.forEach(m => {
            // Live context window calculation
            const limit = m.limit || 128000;
            const percent = Math.min((count / limit) * 100, 100);
            const isFull = count >= limit;
            
            // Format currency
            const rate = exchangeRates[curr];
            const sym = curr === 'INR' ? '‚Çπ' : '$';
            const f = (val) => sym + (val * rate).toFixed(val * rate < 0.01 ? 4 : 2);

            html += `<tr>
                <td>
                    <div style="font-weight:700; color:${isFull ? 'var(--danger)' : 'var(--brand)'}">
                        ${m.name} ${isFull ? '‚ö†Ô∏è FULL' : ''}
                    </div>
                    <div style="font-size:11px; color:var(--text-muted)">Max: ${(limit/1000)}K tokens</div>
                    <div class="ctx-container">
                        <div class="ctx-bar-bg">
                            <div class="ctx-bar-fill" style="width:${percent}%; background:${isFull ? 'var(--danger)' : 'var(--brand)'}"></div>
                        </div>
                    </div>
                </td>
                <td class="num">${f(m.costIn)}</td>
                <td class="num">${f(m.costOut)}</td>
                <td class="num" style="color:var(--brand)">${f(m.total)}</td>
            </tr>`;
        });

        document.getElementById('table-body').innerHTML = html;
        
        // Update big total (average of visible models)
        const avg = results.reduce((a,b) => a + b.total, 0) / (results.length || 1);
        const sym = curr === 'INR' ? '‚Çπ' : '$';
        document.getElementById('total-cost').innerText = sym + (avg * exchangeRates[curr]).toFixed(2);
    }

    function saveToHistory() {
        const text = document.getElementById('input').value.substring(0, 30);
        if(!text) return;
        const div = document.createElement('div');
        div.style.padding = "10px";
        div.style.borderBottom = "1px solid var(--border)";
        div.innerHTML = `<b>${new Date().toLocaleTimeString()}</b><br>${text}...`;
        document.getElementById('history-list').prepend(div);
    }

    init();
</script>
</body>
</html>
